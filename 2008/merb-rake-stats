<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><title>Merb rake stats</title><link href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700|Bitter:400,700,400italic|Open+Sans:300italic,400italic,700italic,400,300,700" media="screen" rel="stylesheet" type="text/css" /><link href="../assets/stylesheets/all-f5ec2720.css" media="screen" rel="stylesheet" type="text/css" /><script src="../assets/javascripts/all-eca7008a.js" type="text/javascript"></script></head><body class="x2008 x2008_merb-rake-stats"><div class="navbar navbar-default"><div class="navbar-collapse collapse navbar-responsive-collapse"><div class="container"><ul class="nav navbar-nav"><li><a class="navbar-brand" href="/">Blog</a></li><li><a class="navbar-brand" href="/about.html">About</a></li><li><a class="navbar-brand" href="/projects.html">Projects</a></li><li><a class="navbar-brand" href="/talks.html">Talks</a></li></ul></div></div></div><div class="container"><article class="post"><div class="page-header"><div class="row"><div class="col-md-10"><h1>Merb rake stats</h1></div><div class="col-md-2 post-date"><time datetime="2008-08-01">Aug  1, 2008</time></div></div></div><div class="alert alert-info">This article is written in Polish and was originally
<a href="http://teamon.jogger.pl/2008/08/01/merb-rake-stats">published at Jogger</a>.</div><div class="lead"><p>Dzisiaj bez komentarza.</p>

<p><img alt="merb stats screenshot" width="615" height="483" src="../assets/images/blog/merb-rake-stats/merb-stats-fd7dde19.png" /></p>
<pre class="highlight ruby"><span class="c1"># lib/tasks/stats.rake</span>
<span class="n">desc</span> <span class="s2">"LOC statistic"</span>
<span class="n">task</span> <span class="ss">:stats</span> <span class="k">do</span>
  <span class="no">STATISTICS_DIRS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:controllers</span>  <span class="o">=&gt;</span> <span class="s1">'app/controllers'</span><span class="p">,</span>
    <span class="ss">:helpers</span>      <span class="o">=&gt;</span> <span class="s1">'app/helpers'</span><span class="p">,</span>
    <span class="ss">:models</span>       <span class="o">=&gt;</span> <span class="s1">'app/models'</span><span class="p">,</span>
    <span class="ss">:lib</span>          <span class="o">=&gt;</span> <span class="s1">'lib'</span><span class="p">,</span>
    <span class="ss">:spec</span>         <span class="o">=&gt;</span> <span class="s1">'spec'</span>
  <span class="p">}</span>
  <span class="no">EMPTY_STATS</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:lines</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:loc</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:classes</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:modules</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:methods</span> <span class="o">=&gt;</span> <span class="mi">0</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">show_line</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="n">ce</span> <span class="o">=</span> <span class="n">color</span> <span class="p">?</span> <span class="s2">"</span><span class="se">\033</span><span class="s2">[0m"</span> <span class="p">:</span> <span class="s2">""</span>
    <span class="nb">puts</span>  <span class="s2">"| </span><span class="si">#{</span><span class="n">color</span><span class="si">}#{</span><span class="nb">name</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">capitalize</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="si">}#{</span><span class="n">ce</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
          <span class="s2">"| </span><span class="si">#{</span><span class="n">color</span><span class="si">}#{</span><span class="n">stats</span><span class="o">[</span><span class="ss">:lines</span><span class="o">]</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="si">}#{</span><span class="n">ce</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
          <span class="s2">"| </span><span class="si">#{</span><span class="n">color</span><span class="si">}#{</span><span class="n">stats</span><span class="o">[</span><span class="ss">:loc</span><span class="o">]</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="si">}#{</span><span class="n">ce</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
          <span class="s2">"| </span><span class="si">#{</span><span class="n">color</span><span class="si">}#{</span><span class="n">stats</span><span class="o">[</span><span class="ss">:classes</span><span class="o">]</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="si">}#{</span><span class="n">ce</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
          <span class="s2">"| </span><span class="si">#{</span><span class="n">color</span><span class="si">}#{</span><span class="n">stats</span><span class="o">[</span><span class="ss">:modules</span><span class="o">]</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="si">}#{</span><span class="n">ce</span><span class="si">}</span><span class="s2"> "</span> <span class="o">+</span>
          <span class="s2">"| </span><span class="si">#{</span><span class="n">color</span><span class="si">}#{</span><span class="n">stats</span><span class="o">[</span><span class="ss">:methods</span><span class="o">]</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="si">}#{</span><span class="n">ce</span><span class="si">}</span><span class="s2"> |"</span>
    <span class="nb">puts</span> <span class="n">separator</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">separator</span>
    <span class="s1">'+----------------------+---------+---------+---------+---------+---------+'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">check_dir</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
    <span class="no">Dir</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">file_name</span><span class="o">|</span>
      <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="n">dir</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">).</span><span class="nf">directory?</span> <span class="n">and</span> <span class="p">(</span><span class="sr">/^\./</span> <span class="o">!~</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">check_dir</span><span class="p">(</span><span class="n">dir</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">file_name</span> <span class="o">=~</span> <span class="sr">/.*\.rb$/</span>
        <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">dir</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">).</span><span class="nf">each_line</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
          <span class="vi">@stats</span><span class="o">[</span><span class="ss">:lines</span><span class="o">]</span>    <span class="o">+=</span> <span class="mi">1</span>
          <span class="vi">@stats</span><span class="o">[</span><span class="ss">:loc</span><span class="o">]</span>      <span class="o">+=</span> <span class="mi">1</span> <span class="k">unless</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^\s*$/</span> <span class="o">||</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^\s*#/</span>
          <span class="vi">@stats</span><span class="o">[</span><span class="ss">:classes</span><span class="o">]</span>  <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/class [A-Z]/</span>
          <span class="vi">@stats</span><span class="o">[</span><span class="ss">:modules</span><span class="o">]</span>  <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/module [A-Z]/</span>
          <span class="vi">@stats</span><span class="o">[</span><span class="ss">:methods</span><span class="o">]</span>  <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/def [a-z]/</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="vi">@all</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">total</span> <span class="o">=</span> <span class="no">EMPTY_STATS</span><span class="p">.</span><span class="nf">clone</span>
  <span class="n">ce</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\033</span><span class="s2">[0m"</span>
  <span class="n">cb</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\033</span><span class="s2">[35m"</span>
  <span class="n">cg</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\033</span><span class="s2">[4;32m"</span>
  <span class="n">cr</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\033</span><span class="s2">[31m"</span>

  <span class="nb">puts</span> <span class="n">separator</span>
  <span class="nb">puts</span> <span class="s2">"| </span><span class="si">#{</span><span class="n">cg</span><span class="si">}</span><span class="s2">Name</span><span class="si">#{</span><span class="n">ce</span><span class="si">}</span><span class="s2">                 | </span><span class="si">#{</span><span class="n">cg</span><span class="si">}</span><span class="s2">Lines</span><span class="si">#{</span><span class="n">ce</span><span class="si">}</span><span class="s2">   | </span><span class="si">#{</span><span class="n">cg</span><span class="si">}</span><span class="s2">LOC</span><span class="si">#{</span><span class="n">ce</span><span class="si">}</span><span class="s2">     | </span><span class="si">#{</span><span class="n">cg</span><span class="si">}</span><span class="s2">Classes</span><span class="si">#{</span><span class="n">ce</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">cg</span><span class="si">}</span><span class="s2">Modules</span><span class="si">#{</span><span class="n">ce</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">cg</span><span class="si">}</span><span class="s2">Methods</span><span class="si">#{</span><span class="n">ce</span><span class="si">}</span><span class="s2"> |"</span>
  <span class="nb">puts</span> <span class="n">separator</span>

  <span class="no">STATISTICS_DIRS</span><span class="p">.</span><span class="nf">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">dir</span><span class="o">|</span>
    <span class="vi">@stats</span> <span class="o">=</span> <span class="no">EMPTY_STATS</span><span class="p">.</span><span class="nf">clone</span>
    <span class="n">check_dir</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
    <span class="vi">@all</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@stats</span>
    <span class="n">show_line</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="vi">@stats</span><span class="p">)</span>
    <span class="vi">@stats</span><span class="p">.</span><span class="nf">each_pair</span> <span class="p">{</span> <span class="o">|</span><span class="n">type</span><span class="p">,</span> <span class="n">count</span><span class="o">|</span> <span class="n">total</span><span class="o">[</span><span class="n">type</span><span class="o">]</span> <span class="o">+=</span> <span class="n">count</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">show_line</span><span class="p">(</span><span class="s1">'Total'</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>

  <span class="n">code_loc</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:controllers</span><span class="p">,</span> <span class="ss">:helpers</span><span class="p">,</span> <span class="ss">:models</span><span class="o">]</span><span class="p">.</span><span class="nf">inject</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">sum</span><span class="p">,</span> <span class="n">e</span><span class="o">|</span> <span class="n">sum</span> <span class="o">+=</span> <span class="vi">@all</span><span class="o">[</span><span class="n">e</span><span class="o">][</span><span class="ss">:loc</span><span class="o">]</span> <span class="p">}</span>
  <span class="n">test_loc</span> <span class="o">=</span> <span class="vi">@all</span><span class="o">[</span><span class="ss">:spec</span><span class="o">][</span><span class="ss">:loc</span><span class="o">]</span>

  <span class="nb">puts</span> <span class="s2">"   Code LOC: </span><span class="si">#{</span><span class="n">cb</span><span class="si">}#{</span><span class="n">code_loc</span><span class="si">}#{</span><span class="n">ce</span><span class="si">}</span><span class="s2">     Test LOC: </span><span class="si">#{</span><span class="n">cb</span><span class="si">}#{</span><span class="n">test_loc</span><span class="si">}#{</span><span class="n">ce</span><span class="si">}</span><span class="s2">     Test to code radio:  </span><span class="si">#{</span><span class="n">cb</span><span class="si">}</span><span class="s2">1:%0.2f</span><span class="si">#{</span><span class="n">ce</span><span class="si">}</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_loc</span><span class="p">.</span><span class="nf">to_f</span> <span class="sr">/ code_loc.to_f)
  puts
end
</span></pre></div></article><div class="page-header"><h2>Comments</h2></div><div class="alert alert-info">Please comment at the <a href="http://teamon.jogger.pl/2008/08/01/merb-rake-stats">original post</a>.</div><ul class="pager"><li class="next"><a href="/2008/merb-fixtures">Older post →</a></li><li class="previous"><a href="/2008/latwiejsze-drukowanie-z-klp-pl">← Newer post</a></li></ul></div><footer><div class="container"><div class="page-header"></div><div class="row"><div class="col-md-12"><ul class="list-unstyled"><li class="pull-right"><a href="#top">Back to top ↑</a></li><li><a href="/">Blog</a></li><li><a href="/about.html">About</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/talks.html">Talks</a></li><li>|</li><li><a href="http://github.com/teamon">GitHub</a></li><li><a href="http://twitter.com/iteamon">Twitter</a></li><li><a href="http://monterail.com">Monterail</a></li><li><a href="http://codetunes.com">Codetunes</a></li></ul></div></div><div class="row"><div class="col-md-12"><p>Copyright 2007-2014 &mdash; Tymon Tobolski <br />Based on <a href="http://bootswatch.com/lumen/">Lumen Bootswatch</a>. Web fonts from <a href="http://www.google.com/webfonts">Google</a>. </p></div></div></div></footer></body></html>