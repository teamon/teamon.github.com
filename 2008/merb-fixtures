<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><title>Merb fixtures</title><link href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700|Bitter:400,700,400italic|Open+Sans:300italic,400italic,700italic,400,300,700" media="screen" rel="stylesheet" type="text/css" /><link href="../assets/stylesheets/all-f5ec2720.css" media="screen" rel="stylesheet" type="text/css" /><script src="../assets/javascripts/all-eca7008a.js" type="text/javascript"></script></head><body class="x2008 x2008_merb-fixtures"><div class="navbar navbar-default"><div class="navbar-collapse collapse navbar-responsive-collapse"><div class="container"><ul class="nav navbar-nav"><li><a class="navbar-brand" href="/">Blog</a></li><li><a class="navbar-brand" href="/about.html">About</a></li><li><a class="navbar-brand" href="/projects.html">Projects</a></li><li><a class="navbar-brand" href="/talks.html">Talks</a></li></ul></div></div></div><div class="container"><article class="post"><div class="page-header"><div class="row"><div class="col-md-10"><h1>Merb fixtures</h1></div><div class="col-md-2 post-date"><time datetime="2008-07-30">Jul 30, 2008</time></div></div></div><div class="alert alert-info">This article is written in Polish and was originally
<a href="http://teamon.jogger.pl/2008/07/30/merb-fixtures">published at Jogger</a>.</div><div class="lead"><p>Ostatnio szukałem jakiegoś dobrego narzędzia do fixtures (nie mam pojęcia jak to można po polsku nazwa) w Merbie i znalazłem projekt na githubie <a href="http://github.com/botanicus/merb-fixtures/tree/master">merb-fixtures</a>. Niestety okazało się, że sprawia pewne problemy w szczególności z <a href="http://github.com/sam/dm-more/tree/master/dm-is-nested\_set">dm-is-nested_set</a> z paczki dm-more DataMappera. Jednak postanowiłem się nie poddawać i korzystając z kodu merb-fixtures napisać coś własnego.</p>

<p>Cała zawartość pliku <code>fixtures.rb</code> prezentuje się tak:</p>
<pre class="highlight ruby"><span class="k">module</span> <span class="nn">Fixtures</span>
  <span class="k">class</span> <span class="nc">Manager</span>
    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
      <span class="k">def</span> <span class="nf">init</span>
        <span class="vc">@@fixtures</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">load</span>
        <span class="no">Merb</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="s2">"Loading fixtures ..."</span><span class="p">)</span>
        <span class="k">unless</span> <span class="no">Merb</span><span class="p">.</span><span class="nf">env?</span><span class="p">(</span><span class="s2">"production"</span><span class="p">)</span>
          <span class="n">directory</span> <span class="o">=</span> <span class="no">Merb</span><span class="p">.</span><span class="nf">root</span> <span class="sr">/ "app" /</span> <span class="s2">"fixtures"</span>
          <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="no">Dir</span><span class="o">[</span><span class="n">directory</span> <span class="o">/</span> <span class="s2">"*.rb"</span><span class="o">]</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
              <span class="no">Kernel</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">else</span>
            <span class="k">raise</span> <span class="s1">'FixturesDirectoryNotFound'</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">unless</span> <span class="n">object</span> <span class="o">=</span> <span class="n">klass</span><span class="p">.</span><span class="nf">fixture</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
          <span class="n">object</span> <span class="o">=</span> <span class="n">klass</span><span class="p">.</span><span class="nf">new</span>
          <span class="vc">@@fixtures</span><span class="o">[</span><span class="n">klass</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="nb">name</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">object</span><span class="p">}</span>
        <span class="k">end</span>
        <span class="n">object</span><span class="p">.</span><span class="nf">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="k">if</span> <span class="nb">block_given?</span>
        <span class="n">object</span><span class="p">.</span><span class="nf">save!</span> <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">dirty?</span>
        <span class="n">object</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">fixture</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fix</span> <span class="o">=</span> <span class="p">(</span><span class="vc">@@fixtures</span><span class="o">[</span><span class="n">klass</span><span class="o">]</span> <span class="o">||=</span> <span class="o">[]</span><span class="p">).</span><span class="nf">find</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">==</span> <span class="nb">name</span><span class="p">}</span>
          <span class="n">fix</span><span class="o">[</span><span class="ss">:object</span><span class="o">]</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">fixtures</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
        <span class="vc">@@fixtures</span><span class="o">[</span><span class="n">klass</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">delete_fixtures</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
        <span class="vc">@@fixtures</span><span class="o">[</span><span class="n">klass</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">save_all</span>
        <span class="vc">@@fixtures</span><span class="p">.</span><span class="nf">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="n">_</span><span class="p">,</span> <span class="n">fixtures</span><span class="o">|</span>
          <span class="n">fixtures</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">[</span><span class="ss">:object</span><span class="o">]</span><span class="p">.</span><span class="nf">save</span><span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Extensions</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
      <span class="n">base</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">ClassMethods</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">module</span> <span class="nn">ClassMethods</span>
      <span class="k">def</span> <span class="nf">fixture</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
        <span class="no">Manager</span><span class="p">.</span><span class="nf">fixture</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">fixtures</span>
        <span class="no">Manager</span><span class="p">.</span><span class="nf">fixtures</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">delete_fixtures</span>
        <span class="no">Manager</span><span class="p">.</span><span class="nf">delete_fixtures</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">models</span> <span class="o">=</span> <span class="o">[]</span>
<span class="no">ObjectSpace</span><span class="p">.</span><span class="nf">each_object</span><span class="p">(</span><span class="no">Class</span><span class="p">)</span>  <span class="k">do</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">klass</span><span class="p">.</span><span class="nf">included_modules</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="no">DataMapper</span><span class="o">::</span><span class="no">Resource</span><span class="p">)</span>
    <span class="n">klass</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="no">Fixtures</span><span class="o">::</span><span class="no">Extensions</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">Kernel</span>
  <span class="k">def</span> <span class="nf">fixture_for</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="no">Fixtures</span><span class="o">::</span><span class="no">Manager</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
<p>Teraz krótko o tym jak się tego używa.</p>

<p>Po pierwsze wrzucamy plik fixtures.rb do katalogu <code>lib</code> i dodajemy w pliku <code>config/init.rb</code></p>
<pre class="highlight ruby"><span class="no">Merb</span><span class="o">::</span><span class="no">BootLoader</span><span class="p">.</span><span class="nf">after_app_loads</span> <span class="k">do</span>
  <span class="nb">require</span> <span class="s1">'lib/fixtures.rb'</span>
<span class="k">end</span>
</pre>
<p>Jest to bardzo istotne aby umieścić <code>require</code> w tym bloku ponieważ biblioteka wymaga dostępu do klas modeli.</p>

<p>Następnie tworzymy katalog <code>app/fixtures</code> i w nim dla przykładu plik <code>category.rb</code> o zawartości:</p>
<pre class="highlight ruby"><span class="n">fixture_for</span><span class="p">(</span><span class="no">Category</span><span class="p">,</span> <span class="ss">:root</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'root'</span>
<span class="k">end</span>

  <span class="n">fixture_for</span><span class="p">(</span><span class="no">Category</span><span class="p">,</span> <span class="ss">:space_ships</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Space ships'</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">parent</span> <span class="o">=</span> <span class="no">Category</span><span class="p">.</span><span class="nf">fixture</span><span class="p">(</span><span class="ss">:root</span><span class="p">)</span>
  <span class="k">end</span>

    <span class="n">fixture_for</span><span class="p">(</span><span class="no">Category</span><span class="p">,</span> <span class="ss">:fast_space_ships</span><span class="p">)</span> <span class="k">do</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Fast ships'</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">parent</span> <span class="o">=</span> <span class="no">Category</span><span class="p">.</span><span class="nf">fixture</span><span class="p">(</span><span class="ss">:space_ships</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">fixture_for</span><span class="p">(</span><span class="no">Category</span><span class="p">,</span> <span class="ss">:big_space_ships</span><span class="p">)</span> <span class="k">do</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Big ships'</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">parent</span> <span class="o">=</span> <span class="no">Category</span><span class="p">.</span><span class="nf">fixture</span><span class="p">(</span><span class="ss">:space_ships</span><span class="p">)</span>
    <span class="k">end</span>

  <span class="n">fixture_for</span><span class="p">(</span><span class="no">Category</span><span class="p">,</span> <span class="ss">:robots</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Robots'</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">parent</span> <span class="o">=</span> <span class="no">Category</span><span class="p">.</span><span class="nf">fixture</span><span class="p">(</span><span class="ss">:root</span><span class="p">)</span>
  <span class="k">end</span>

    <span class="n">fixture_for</span><span class="p">(</span><span class="no">Category</span><span class="p">,</span> <span class="ss">:human_like_robots</span><span class="p">)</span> <span class="k">do</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Human like'</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">parent</span> <span class="o">=</span> <span class="no">Category</span><span class="p">.</span><span class="nf">fixture</span><span class="p">(</span><span class="ss">:robots</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">fixture_for</span><span class="p">(</span><span class="no">Category</span><span class="p">,</span> <span class="ss">:other_robots</span><span class="p">)</span> <span class="k">do</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s1">'Other'</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">parent</span> <span class="o">=</span> <span class="no">Category</span><span class="p">.</span><span class="nf">fixture</span><span class="p">(</span><span class="ss">:robots</span><span class="p">)</span>
    <span class="k">end</span>
</pre>
<p>Teraz możemy załadować (poprzez <code>merb -i</code>) dane do bazy za pomocą <code>Fixtures::Manager.load</code>. Jednak najbardziej przydanym wykorzystaniem fixtures są testy&hellip;</p>

<p>W pliku <code>spec/spec_helper.rb</code> dodajemy:</p>
<pre class="highlight ruby"><span class="no">DataMapper</span><span class="p">.</span><span class="nf">auto_migrate!</span>
<span class="no">Fixtures</span><span class="o">::</span><span class="no">Manager</span><span class="p">.</span><span class="nf">init</span>

<span class="k">def</span> <span class="nf">fixtures</span><span class="p">(</span><span class="o">*</span><span class="n">classes</span><span class="p">)</span>
  <span class="no">Fixtures</span><span class="o">::</span><span class="no">Manager</span><span class="p">.</span><span class="nf">load</span>
  <span class="n">classes</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span><span class="o">|</span><span class="n">klass</span><span class="o">|</span>
    <span class="n">klass</span><span class="p">.</span><span class="nf">fixtures</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
      <span class="nb">instance_variable_set</span><span class="p">(</span><span class="s2">"@</span><span class="si">#{</span><span class="n">e</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">e</span><span class="o">[</span><span class="ss">:object</span><span class="o">]</span><span class="p">.</span><span class="nf">clone</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre>
<p>Teraz w pliku <code>category_spec.rb</code>:</p>
<pre class="highlight ruby"><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">fixtures</span><span class="p">(</span><span class="no">Category</span><span class="p">)</span>
  <span class="c1"># można załadować kilka na raz np.</span>
  <span class="c1"># fixtures(Category, Product, User)</span>
<span class="k">end</span>
</pre>
<p>Da nam to nie tylko dostęp do obiektów za pomocą <code>Klasa.fixture(:nazwa)</code>, ale też <code>@nazwa</code> (w tym przypadku np. <code>@space_ships</code>)</p>

<p>Nie pozostaje nic innego tylko zabrać się do wygodnego pisanie testów ;)</p>

<p>P.S. Znowu wyszła tona kodu + dwa zdania&hellip;</p>
</div></article><div class="page-header"><h2>Comments</h2></div><div class="alert alert-info">Please comment at the <a href="http://teamon.jogger.pl/2008/07/30/merb-fixtures">original post</a>.</div><ul class="pager"><li class="next"><a href="/2008/blad-w-ruby-array-shuffle">Older post →</a></li><li class="previous"><a href="/2008/merb-rake-stats">← Newer post</a></li></ul></div><footer><div class="container"><div class="page-header"></div><div class="row"><div class="col-md-12"><ul class="list-unstyled"><li class="pull-right"><a href="#top">Back to top ↑</a></li><li><a href="/">Blog</a></li><li><a href="/about.html">About</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/talks.html">Talks</a></li><li>|</li><li><a href="http://github.com/teamon">GitHub</a></li><li><a href="http://twitter.com/iteamon">Twitter</a></li><li><a href="http://monterail.com">Monterail</a></li><li><a href="http://codetunes.com">Codetunes</a></li></ul></div></div><div class="row"><div class="col-md-12"><p>Copyright 2007-2014 &mdash; Tymon Tobolski <br />Based on <a href="http://bootswatch.com/lumen/">Lumen Bootswatch</a>. Web fonts from <a href="http://www.google.com/webfonts">Google</a>. </p></div></div></div></footer></body></html>