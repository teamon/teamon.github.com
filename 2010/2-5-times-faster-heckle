<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><title>2.5 times faster heckle</title><link href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700|Bitter:400,700,400italic|Open+Sans:300italic,400italic,700italic,400,300,700" media="screen" rel="stylesheet" type="text/css" /><link href="../assets/stylesheets/all-f5ec2720.css" media="screen" rel="stylesheet" type="text/css" /><script src="../assets/javascripts/all-eca7008a.js" type="text/javascript"></script></head><body class="x2010 x2010_2-5-times-faster-heckle"><div class="navbar navbar-default"><div class="navbar-collapse collapse navbar-responsive-collapse"><div class="container"><ul class="nav navbar-nav"><li><a class="navbar-brand" href="/">Blog</a></li><li><a class="navbar-brand" href="/about.html">About</a></li><li><a class="navbar-brand" href="/projects.html">Projects</a></li><li><a class="navbar-brand" href="/talks.html">Talks</a></li></ul></div></div></div><div class="container"><article class="post"><div class="page-header"><div class="row"><div class="col-md-10"><h1>2.5 times faster heckle</h1></div><div class="col-md-2 post-date"><time datetime="2010-07-26">Jul 26, 2010</time></div></div></div><div class="alert alert-info">This article was originally
<a href="http://tumblr.teamon.eu/post/738280016/2-5-times-faster-heckle">published at Tumblr</a>.</div><div class="lead"><p>RSpec has built-in support for <a href="http://rspec.info/documentation/tools/heckle.html">heckle</a>,
but executing every <code>$ spec spec_file —heckle my_method</code> from command line is boring.</p>

<p>Why not use rake?</p>
<pre class="highlight ruby"><span class="n">desc</span> <span class="s2">"Heckle all"</span>
<span class="n">task</span> <span class="ss">:heckle_all</span> <span class="k">do</span>
  <span class="n">sh</span> <span class="s2">"spec spec/models/address_spec.rb --heckle 'Address#to_s'"</span>
  <span class="n">sh</span> <span class="s2">"spec spec/models/category_spec.rb --heckle 'Category#permalink'"</span>
  <span class="n">sh</span> <span class="s2">"spec spec/models/facturer_spec.rb --heckle 'Facturer#permalink'"</span>
  <span class="n">sh</span> <span class="s2">"spec spec/models/product_spec.rb --heckle 'Product#permalink'"</span>
  <span class="n">sh</span> <span class="s2">"spec spec/integration/cart_spec.rb --heckle 'Cart#&lt;&lt;'"</span>
  <span class="n">sh</span> <span class="s2">"spec spec/integration/cart_spec.rb --heckle 'Cart#empty?'"</span>
  <span class="n">sh</span> <span class="s2">"spec spec/integration/cart_spec.rb --heckle 'Cart#clear!'"</span>
  <span class="n">sh</span> <span class="s2">"spec spec/integration/cart_spec.rb --heckle 'Cart#total_price'"</span>
  <span class="n">sh</span> <span class="s2">"spec spec/integration/cart_spec.rb --heckle 'Cart#quantity_of'"</span>
  <span class="n">sh</span> <span class="s2">"spec spec/integration/cart_spec.rb --heckle 'CartItem#total_price'"</span>
<span class="k">end</span>
</pre>
<p>Yeah, nice one! Well, not really. <code>$ rake heckle_all</code> takes about <strong>87 seconds</strong> to complete. First line executes shell script <code>spec</code> that runs ruby, then spec with heckle, then next line starts its own ruby again and again. Ruby starts slowly. Can it be done better?</p>

<p>Yes! After some hacking I ended up with something like this:</p>
<pre class="highlight ruby"><span class="n">desc</span> <span class="s2">"Heckle all"</span>
<span class="n">task</span> <span class="ss">:heckle_all</span> <span class="k">do</span>
  <span class="n">heckle</span> <span class="s2">"spec/models/address_spec.rb"</span><span class="p">,</span> <span class="s2">"Address#to_s"</span>
  <span class="n">heckle</span> <span class="s2">"spec/models/category_spec.rb"</span><span class="p">,</span> <span class="s2">"Category#permalink"</span>
  <span class="n">heckle</span> <span class="s2">"spec/models/facturer_spec.rb"</span><span class="p">,</span> <span class="s2">"Facturer#permalink"</span>
  <span class="n">heckle</span> <span class="s2">"spec/models/product_spec.rb"</span><span class="p">,</span> <span class="s2">"Product#permalink"</span>
  <span class="n">heckle</span> <span class="s2">"spec/integration/cart_spec.rb"</span><span class="p">,</span> <span class="s2">"Cart#&lt;&lt;"</span>
  <span class="n">heckle</span> <span class="s2">"spec/integration/cart_spec.rb"</span><span class="p">,</span> <span class="s2">"Cart#empty?"</span>
  <span class="n">heckle</span> <span class="s2">"spec/integration/cart_spec.rb"</span><span class="p">,</span> <span class="s2">"Cart#clear!"</span>
  <span class="n">heckle</span> <span class="s2">"spec/integration/cart_spec.rb"</span><span class="p">,</span> <span class="s2">"Cart#total_price"</span>
  <span class="n">heckle</span> <span class="s2">"spec/integration/cart_spec.rb"</span><span class="p">,</span> <span class="s2">"Cart#quantity_of"</span>
  <span class="n">heckle</span> <span class="s2">"spec/integration/cart_spec.rb"</span><span class="p">,</span> <span class="s2">"CartItem#total_price"</span>
<span class="k">end</span>

<span class="nb">require</span> <span class="s2">"spec"</span>
<span class="k">def</span> <span class="nf">heckle</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">method</span><span class="p">)</span>
  <span class="n">options</span> <span class="o">=</span> <span class="no">Spec</span><span class="o">::</span><span class="no">Runner</span><span class="o">::</span><span class="no">Options</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vg">$stderr</span><span class="p">,</span> <span class="vg">$stdout</span><span class="p">)</span>
  <span class="n">options</span><span class="p">.</span><span class="nf">load_heckle_runner</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
  <span class="n">options</span><span class="p">.</span><span class="nf">files</span> <span class="o">&lt;&lt;</span> <span class="n">file</span>
  <span class="no">Spec</span><span class="o">::</span><span class="no">Runner</span><span class="p">.</span><span class="nf">use</span> <span class="n">options</span>
  <span class="no">Spec</span><span class="o">::</span><span class="no">Runner</span><span class="p">.</span><span class="nf">run</span>
<span class="k">end</span>
</pre>
<p>Woohoo, <code>$ rake heckle_all</code> now takes <em>only</em> <strong>33 seconds</strong>. Thats <strong>2.5 times</strong> faster! ;]</p>

<p>Yes, I know, nothing to be excited about, but imagine you have some more code. One hour instead of two and a half! Isn&rsquo;t that impressive?</p>

<p>It couldn&rsquo;t be a benchmark post without nice chart</p>

<p><img src="http://media.tumblr.com/tumblr_l4mi0qWijR1qat4ul.png" /></p>
</div></article><div class="page-header"><h2>Comments</h2></div><div class="alert alert-info">Please comment at the <a href="http://tumblr.teamon.eu/post/738280016/2-5-times-faster-heckle">original post</a>.</div><ul class="pager"><li class="next"><a href="/2010/intellij-idea-monokai-color-theme">Older post →</a></li><li class="previous"><a href="/2010/better-scoped-rails-engines-routing">← Newer post</a></li></ul></div><footer><div class="container"><div class="page-header"></div><div class="row"><div class="col-md-12"><ul class="list-unstyled"><li class="pull-right"><a href="#top">Back to top ↑</a></li><li><a href="/">Blog</a></li><li><a href="/about.html">About</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/talks.html">Talks</a></li><li>|</li><li><a href="http://github.com/teamon">GitHub</a></li><li><a href="http://twitter.com/iteamon">Twitter</a></li><li><a href="http://monterail.com">Monterail</a></li><li><a href="http://codetunes.com">Codetunes</a></li></ul></div></div><div class="row"><div class="col-md-12"><p>Copyright 2007-2014 &mdash; Tymon Tobolski <br />Based on <a href="http://bootswatch.com/lumen/">Lumen Bootswatch</a>. Web fonts from <a href="http://www.google.com/webfonts">Google</a>. </p></div></div></div></footer></body></html>